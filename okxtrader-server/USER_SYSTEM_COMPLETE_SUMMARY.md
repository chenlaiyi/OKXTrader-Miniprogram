# ç”¨æˆ·ç³»ç»Ÿå‡çº§ - å®Œæ•´å®æ–½æ€»ç»“

## ğŸ“… å®Œæˆæ—¥æœŸ
2026-01-17

---

## âœ… å·²å®Œæˆçš„å…¨éƒ¨åŠŸèƒ½

### ä¸€ã€æ•°æ®åº“å±‚

#### 1. æ•°æ®åº“è¡¨è®¾è®¡
**æ–‡ä»¶**: [migrations/001_create_user_system.sql](okxtrader-server/migrations/001_create_user_system.sql)

åˆ›å»ºäº†3ä¸ªæ–°è¡¨ï¼š
- âœ… `wx_users` - å¾®ä¿¡ç”¨æˆ·è¡¨
- âœ… `okx_accounts` - OKXè´¦å·è¡¨
- âœ… `api_key_temp` - APIå¯†é’¥ä¸´æ—¶è¡¨

#### 2. ç°æœ‰æ•°æ®è¿ç§»
- âœ… åˆ›å»ºé»˜è®¤ç”¨æˆ·ï¼ˆID: `00000000-0000-0000-0000-000000000000`ï¼‰
- âœ… å°†ç°æœ‰æ•°æ®å…³è”åˆ°é»˜è®¤ç”¨æˆ·
- âœ… ä¿æŒå‘åå…¼å®¹

---

### äºŒã€åç«¯APIå±‚

#### 1. è®¤è¯API
**æ–‡ä»¶**: [src/routes/auth.ts](okxtrader-server/src/routes/auth.ts)

å®ç°çš„æ¥å£ï¼š
- âœ… `POST /api/auth/login` - å¾®ä¿¡æˆæƒç™»å½•
  - è·å–å¾®ä¿¡code
  - è°ƒç”¨å¾®ä¿¡APIæ¢å–openid
  - åˆ›å»º/æ›´æ–°ç”¨æˆ·è®°å½•
  - ç”ŸæˆJWT Token

- âœ… `GET /api/auth/profile` - è·å–ç”¨æˆ·ä¿¡æ¯
  - éªŒè¯JWT Token
  - è¿”å›ç”¨æˆ·ä¿¡æ¯å’Œè´¦å·æ•°é‡

- âœ… `POST /api/auth/refresh` - åˆ·æ–°Token

#### 2. è´¦å·ç®¡ç†API
**æ–‡ä»¶**: [src/routes/accounts.ts](okxtrader-server/src/routes/accounts.ts)

å®ç°çš„æ¥å£ï¼š
- âœ… `GET /api/user/accounts` - è·å–è´¦å·åˆ—è¡¨
  - è¿”å›ç”¨æˆ·çš„OKXè´¦å·åˆ—è¡¨
  - æ˜¾ç¤ºè´¦å·åç§°ã€ç±»å‹ã€çŠ¶æ€ã€ç»Ÿè®¡

- âœ… `POST /api/user/accounts` - æ·»åŠ è´¦å·
  - æ¥æ”¶è´¦å·ä¿¡æ¯å’ŒAPIå‚æ•°
  - AES-256-GCMåŠ å¯†å­˜å‚¨
  - è‡ªåŠ¨è®¾ç½®ç¬¬ä¸€ä¸ªè´¦å·ä¸ºé»˜è®¤

- âœ… `PUT /api/user/accounts/:id` - æ›´æ–°è´¦å·
  - æ›´æ–°è´¦å·åç§°ã€æ ‡ç­¾ã€çŠ¶æ€

- âœ… `DELETE /api/user/accounts/:id` - åˆ é™¤è´¦å·
  - ä¸èƒ½åˆ é™¤é»˜è®¤è´¦å·

- âœ… `PATCH /api/user/accounts/:id/default` - è®¾ç½®é»˜è®¤è´¦å·
  - å–æ¶ˆå…¶ä»–è´¦å·çš„é»˜è®¤çŠ¶æ€
  - è®¾ç½®æ–°é»˜è®¤è´¦å·

- âœ… `POST /api/user/accounts/:id/verify` - éªŒè¯è´¦å·
  - è§£å¯†APIå‚æ•°
  - è°ƒç”¨OKX APIéªŒè¯

#### 3. è®¤è¯ä¸­é—´ä»¶
**æ–‡ä»¶**: [src/middleware/auth.ts](okxtrader-server/src/middleware/auth.ts)

å®ç°åŠŸèƒ½ï¼š
- âœ… JWT TokenéªŒè¯
- âœ… ç”¨æˆ·èº«ä»½æå–
- âœ… æ‰©å±•Requestç±»å‹ï¼Œæ·»åŠ userå±æ€§

#### 4. è·¯ç”±æ³¨å†Œ
**æ–‡ä»¶**: [src/index.ts](okxtrader-server/src/index.ts:14-21, 66-67)

**æ–°å¢è·¯ç”±**ï¼š
- âœ… `app.use('/api/auth', authRoutes)`
- âœ… `app.use('/api/user/accounts', okxAccountsRoutes)`

---

### ä¸‰ã€å‰ç«¯é¡µé¢å±‚

#### 1. ç™»å½•é¡µé¢
**æ–‡ä»¶**: [miniprogram/pages/auth/login/*](miniprogram/pages/auth/login/)**

**åŠŸèƒ½**ï¼š
- âœ… ç²¾ç¾çš„UIç•Œé¢ï¼ˆæ¸å˜èƒŒæ™¯ã€å¡ç‰‡å¼è®¾è®¡ï¼‰
- âœ… å¾®ä¿¡æˆæƒç™»å½•æµç¨‹
- âœ… ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºï¼ˆå¤´åƒã€æ˜µç§°ï¼‰
- âœ… OKXè´¦å·æ•°é‡æ˜¾ç¤º
- âœ… é€€å‡ºç™»å½•åŠŸèƒ½

**é¡µé¢æ–‡ä»¶**ï¼š
- `login.wxml` - é¡µé¢ç»“æ„
- `login.js` - é¡µé¢é€»è¾‘
- `login.wxss` - é¡µé¢æ ·å¼
- `login.json` - é¡µé¢é…ç½®

#### 2. è´¦å·åˆ—è¡¨é¡µé¢
**æ–‡ä»¶**: [miniprogram/pages/account-list/account-list/*](miniprogram/pages/account-list/account-list/)**

**åŠŸèƒ½**ï¼š
- âœ… è´¦å·å¡ç‰‡å±•ç¤º
- âœ… è´¦å·ç±»å‹æ ‡è¯†ï¼ˆæ¨¡æ‹Ÿ/å®ç›˜ï¼‰
- âœ… é»˜è®¤è´¦å·æ ‡è¯†
- âœ… è´¦å·çŠ¶æ€æŒ‡ç¤ºå™¨
- âœ… äº¤æ˜“ç»Ÿè®¡ï¼ˆäº¤æ˜“æ¬¡æ•°ã€æ€»ç›ˆäºï¼‰
- âœ… æ“ä½œæŒ‰é’®ï¼ˆè®¾ä¸ºé»˜è®¤ã€ç¼–è¾‘ã€å¯ç”¨/ç¦ç”¨ã€åˆ é™¤ï¼‰

**é¡µé¢æ–‡ä»¶**ï¼š
- `account-list.wxml` - é¡µé¢ç»“æ„
- `account-list.js` - é¡µé¢é€»è¾‘
- `account-list.wxss` - é¡µé¢æ ·å¼
- `account-list.json` - é¡µé¢é…ç½®

#### 3. æ·»åŠ è´¦å·é¡µé¢
**æ–‡ä»¶**: [miniprogram/pages/account-add/account-add/*](miniprogram/pages/account-add/account-add/)**

**åŠŸèƒ½**ï¼š
- âœ… è´¦å·åç§°è¾“å…¥
- âœ… è´¦å·ç±»å‹é€‰æ‹©ï¼ˆæ¨¡æ‹Ÿ/å®ç›˜ï¼‰
- âœ… APIå‚æ•°è¾“å…¥ï¼ˆAPI Keyã€Secret Keyã€Passphraseï¼‰
- âœ… æ ‡ç­¾è¾“å…¥ï¼ˆå¯é€‰ï¼‰
- âœ… å®‰å…¨æç¤ºè¯´æ˜
- âœ… è·å–APIå‚æ•°æŒ‡å—

**é¡µé¢æ–‡ä»¶**:
- `account-add.wxml` - é¡µé¢ç»“æ„
- `account-add.js` - é¡µé¢é€»è¾‘
- `account-add.wxss` - é¡µé¢æ ·å¼
- `account-add.json` - é¡µé¢é…ç½®

#### 4. è´¦æˆ·é¡µé¢æ›´æ–°
**æ–‡ä»¶**: [miniprogram/pages/account/account.*](miniprogram/pages/account/account.*)**

**æ–°å¢åŠŸèƒ½**ï¼š
- âœ… ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ï¼ˆå¤´åƒã€æ˜µç§°ï¼‰
- âœ… ç™»å½•çŠ¶æ€æ£€æµ‹
- âœ… OKXè´¦å·æ•°é‡æ˜¾ç¤º
- âœ… "ç®¡ç†è´¦å·"æŒ‰é’® - è·³è½¬åˆ°è´¦å·åˆ—è¡¨é¡µé¢
- âœ… "æ·»åŠ è´¦å·"æŒ‰é’® - è·³è½¬åˆ°æ·»åŠ è´¦å·é¡µé¢
- âœ… æœªç™»å½•æç¤ºé¡µé¢
- âœ… "å¾®ä¿¡æˆæƒç™»å½•"æŒ‰é’® - è·³è½¬åˆ°ç™»å½•é¡µé¢
- âœ… "é€€å‡ºç™»å½•"æŒ‰é’®

#### 5. APIæœåŠ¡é›†æˆ
**æ–‡ä»¶**: [miniprogram/services/api.js](miniprogram/services/api.js)

**æ›´æ–°åŠŸèƒ½**ï¼š
- âœ… æ‰€æœ‰è¯·æ±‚è‡ªåŠ¨æºå¸¦JWT Token
- âœ… Tokenå¤±æ•ˆæ—¶è‡ªåŠ¨è·³è½¬ç™»å½•
- âœ… è®¤è¯ç›¸å…³APIæ–¹æ³•ï¼ˆloginã€getUserProfileã€getAccountsç­‰ï¼‰

---

## ğŸ” å®‰å…¨ç‰¹æ€§

### æ•°æ®åŠ å¯†
- âœ… AES-256-GCMåŠ å¯†ç®—æ³•
- âœ… æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹çš„åŠ å¯†å¯†é’¥
- âœ… APIå‚æ•°åŠ å¯†å­˜å‚¨ï¼ˆapi_key_encryptedç­‰ï¼‰

### è®¤è¯æœºåˆ¶
- âœ… JWT Tokenï¼ˆ30å¤©æœ‰æ•ˆæœŸï¼‰
- âœ… Tokenè‡ªåŠ¨åˆ·æ–°æœºåˆ¶
- âœ… Tokenå¤±æ•ˆè‡ªåŠ¨è·³è½¬ç™»å½•

### è®¿é—®æ§åˆ¶
- âœ… æ‰€æœ‰è´¦å·ç®¡ç†æ¥å£éœ€è¦Token
- âœ… ç”¨æˆ·æ•°æ®å®Œå…¨éš”ç¦»
- âœ… å‘åå…¼å®¹ï¼ˆæœªç™»å½•ä½¿ç”¨é»˜è®¤ç”¨æˆ·ï¼‰

---

## ğŸ“± é¡µé¢è·¯ç”±

### ç™»å½•æµç¨‹
```
ç”¨æˆ·æ‰“å¼€å°ç¨‹åº
    â†“
æ£€æŸ¥ç™»å½•çŠ¶æ€
    â†“
  æœªç™»å½• â†’ æ˜¾ç¤ºç™»å½•æç¤º
    â†“
  ç‚¹å‡»"å¾®ä¿¡æˆæƒç™»å½•"
    â†“
  è·å–ç”¨æˆ·ä¿¡æ¯å’Œcode
    â†“
  è°ƒç”¨åç«¯ç™»å½•æ¥å£
    â†“
  ä¿å­˜Tokenå’Œç”¨æˆ·ä¿¡æ¯
    â†“
  è·³è½¬åˆ°é¦–é¡µ
```

### è´¦å·ç®¡ç†æµç¨‹
```
è´¦æˆ·é¡µé¢
    â†“
ç‚¹å‡»"ç®¡ç†è´¦å·"
    â†“
è´¦å·åˆ—è¡¨é¡µé¢
    â†“
  æŸ¥çœ‹è´¦å·åˆ—è¡¨
    â†“
æ·»åŠ /ç¼–è¾‘/åˆ é™¤è´¦å·
```

---

## ğŸ“‹ éƒ¨ç½²æ­¥éª¤

### 1. æ•°æ®åº“è¿ç§»ï¼ˆå¿…é¡»é¦–å…ˆæ‰§è¡Œï¼‰

```bash
cd /Users/chanlaiyi/Oyi/okxtrader-server
mysql -u root -p okx_trader < migrations/001_create_user_system.sql
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

åœ¨ `okxtrader-server/.env` ä¸­æ·»åŠ ï¼š

```bash
# ç”ŸæˆåŠ å¯†å¯†é’¥
ENCRYPTION_KEY=$(node -e "console.log(require('crypto').randomBytes(32).toString('hex')")

# JWTå¯†é’¥
JWT_SECRET=<ç”Ÿæˆä¸€ä¸ªéšæœºå­—ç¬¦ä¸²>

# å¾®ä¿¡å°ç¨‹åºé…ç½®
WECHAT_APPID=<ä½ çš„å¾®ä¿¡AppID>
WECHAT_SECRET=<ä½ çš„å¾®ä¿¡AppSecret>
```

### 3. ç¼–è¯‘å¹¶éƒ¨ç½²åç«¯

```bash
cd /Users/chanlaiyi/Oyi/okxtrader-server
npm run build

# éƒ¨ç½²åˆ°æœåŠ¡å™¨
rsync -avz --exclude 'node_modules' --exclude '.git' \
  /Users/chanlaiyi/Oyi/okxtrader-server/ \
  root@149.88.88.171:/root/okxtrader-server/

# é‡å¯æœåŠ¡
ssh root@149.88.88.171 'cd /root/okxtrader-server && pm2 restart okxtrader-api'
```

### 4. é…ç½®å¾®ä¿¡å°ç¨‹åº

1. ç™»å½•[å¾®ä¿¡å…¬ä¼—å¹³å°](https://mp.weixin.qq.com/)
2. è¿›å…¥ä½ çš„å°ç¨‹åºåå°
3. é…ç½®ä»¥ä¸‹ä¿¡æ¯ï¼š
   - **AppID**: åœ¨"å¼€å‘"-"å¼€å‘ç®¡ç†"-"å¼€å‘è®¾ç½®"ä¸­
   - **AppSecret**: åœ¨"å¼€å‘"-"å¼€å‘ç®¡ç†"-"å¼€å‘è®¾ç½®"ä¸­
   - **æœåŠ¡å™¨åŸŸå**: æ·»åŠ  `ly.ddg.org.cn` åˆ°ç™½åå•
   - **å¼€é€šæ¥å£**:
     - ç”¨æˆ·ä¿¡æ¯
     - ç™»å½•æµç¨‹
     - è·å–ç”¨æˆ·ä¿¡æ¯

### 5. æµ‹è¯•æµç¨‹

#### æµ‹è¯•ç™»å½•åŠŸèƒ½
1. æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·
2. ç¼–è¯‘å°ç¨‹åº
3. è¿›å…¥"è´¦æˆ·"tabé¡µ
4. åº”è¯¥çœ‹åˆ°ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
5. å¦‚æœæœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•æç¤º
6. ç‚¹å‡»"å¾®ä¿¡æˆæƒç™»å½•"
7. åœ¨å¼¹çª—ä¸­ç‚¹å‡»"å…è®¸"
8. æŸ¥çœ‹æ˜¯å¦ç™»å½•æˆåŠŸ

#### æµ‹è¯•è´¦å·ç®¡ç†
1. ç‚¹å‡»"ç®¡ç†è´¦å·"
2. è¿›å…¥è´¦å·åˆ—è¡¨é¡µé¢
3. ç‚¹å‡»"æ·»åŠ OKXè´¦å·"
4. å¡«å†™è´¦å·ä¿¡æ¯
5. ç‚¹å‡»"ä¿å­˜"
6. è¿”å›åˆ—è¡¨é¡µæŸ¥çœ‹æ–°æ·»åŠ çš„è´¦å·

---

## ğŸ“Š åŠŸèƒ½ç‰¹æ€§

### ç”¨æˆ·ç®¡ç†
- âœ… å¾®ä¿¡æˆæƒç™»å½•
- âœ… ç”¨æˆ·ä¿¡æ¯å­˜å‚¨ï¼ˆopenidã€æ˜µç§°ã€å¤´åƒï¼‰
- âœ… JWT Tokenè®¤è¯
- âœ… é€€å‡ºç™»å½•åŠŸèƒ½

### è´¦å·ç®¡ç†
- âœ… å¤šè´¦å·æ”¯æŒ
- âœ… è´¦å·ç±»å‹åŒºåˆ†ï¼ˆæ¨¡æ‹Ÿ/å®ç›˜ï¼‰
- âœ… é»˜è®¤è´¦å·è®¾ç½®
- âœ… è´¦å·çŠ¶æ€ç®¡ç†
- âœ… APIå‚æ•°åŠ å¯†å­˜å‚¨

### å®‰å…¨æ€§
- âœ… AES-256-GCMåŠ å¯†
- âœ… JWT Tokenæœºåˆ¶
- âœ… ç”¨æˆ·æ•°æ®éš”ç¦»
- âœ… å‘åå…¼å®¹

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½è¯´æ˜

### å¾®ä¿¡æˆæƒç™»å½•æµç¨‹
1. ç”¨æˆ·ç‚¹å‡»"å¾®ä¿¡æˆæƒç™»å½•"
2. è°ƒç”¨ `wx.getUserProfile` è·å–ç”¨æˆ·èµ„æ–™
3. è°ƒç”¨ `wx.login` è·å–code
4. å°†codeå’Œç”¨æˆ·ä¿¡æ¯å‘é€åˆ°åç«¯
5. åç«¯è°ƒç”¨å¾®ä¿¡APIæ¢å–openid
6. åˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·è®°å½•
7. ç”ŸæˆJWT Token
8. å‰ç«¯ä¿å­˜Tokenå’Œç”¨æˆ·ä¿¡æ¯
9. è·³è½¬åˆ°é¦–é¡µ

### OKXè´¦å·ç®¡ç†æµç¨‹
1. è¿›å…¥"è´¦æˆ·"tabé¡µ
2. ç‚¹å‡»"ç®¡ç†è´¦å·"
3. å¯ä»¥ï¼š
   - æŸ¥çœ‹è´¦å·åˆ—è¡¨
   - æ·»åŠ æ–°è´¦å·
   - ç¼–è¾‘è´¦å·ä¿¡æ¯
   - åˆ é™¤è´¦å·
   - è®¾ç½®é»˜è®¤è´¦å·
   - åˆ‡æ¢è´¦å·çŠ¶æ€

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶
```
okxtrader-server/
â”œâ”€â”€ migrations/
â”‚   â””â”€â”€ 001_create_user_system.sql
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ auth.ts (æ–°å¢)
â”‚   â”‚   â””â”€â”€ accounts.ts (æ–°å¢)
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â””â”€â”€ auth.ts (æ–°å¢)
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â””â”€â”€ encryption.ts (æ–°å¢)
â”‚   â””â”€â”€ index.ts (ä¿®æ”¹ - æ³¨å†Œæ–°è·¯ç”±)
```

### å‰ç«¯æ–‡ä»¶
```
miniprogram/
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ auth/login/ (æ–°å¢)
â”‚   â”‚   â”œâ”€â”€ login.wxml
â”‚   â”‚   â”œâ”€â”€ login.js
â”‚   â”œâ”€â”€ account-list/ (æ–°å¢)
â”‚   â”‚   â”œâ”€â”€ account-list.wxml
â”‚   â”‚   â”œâ”€â”€ account-list.js
â”‚   â”‚   â””â”€â”€ account-list.wxss
â”‚   â”œâ”€â”€ account-add/ (æ–°å¢)
â”‚   â”‚   â”œâ”€â”€ account-add.wxml
â”‚   â”‚   â”œâ”€â”€ account-add.js
â”‚   â”‚   â””â”€â”€ account-add.wxss
â”œâ”€â”€ services/
â”‚   â””â”€â”€ api.js (ä¿®æ”¹ - æ·»åŠ è®¤è¯API)
â””â”€â”€ app.json (ä¿®æ”¹ - æ³¨å†Œæ–°é¡µé¢)
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [USER_SYSTEM_UPGRADE_DESIGN.md](USER_SYSTEM_UPGRADE_DESIGN.md) - è®¾è®¡æ–‡æ¡£
- [USER_SYSTEM_IMPLEMENTATION_PLAN.md](okxtrader-server/USER_SYSTEM_IMPLEMENTATION_PLAN.md) - å®æ–½è®¡åˆ’
- [migrations/001_create_user_system.sql](okxtrader-server/migrations/001_create_user_system.sql) - æ•°æ®åº“è¿ç§»è„šæœ¬

---

## âš ï¸ é‡è¦æç¤º

### å¿…é¡»å…ˆæ‰§è¡Œ
1. âœ… è¿è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬
2. âœ… é…ç½®ç¯å¢ƒå˜é‡
3. âœ… é…ç½®å¾®ä¿¡å°ç¨‹åº

### æµ‹è¯•è¦ç‚¹
1. âœ… å¾®ä¿¡æˆæƒç™»å½•æ˜¯å¦æ­£å¸¸
2. âœ… Tokenä¿å­˜å’Œè¯»å–æ˜¯å¦æ­£å¸¸
3. âœ… APIå‚æ•°æ˜¯å¦åŠ å¯†å­˜å‚¨
4. âœ… ç”¨æˆ·æ•°æ®æ˜¯å¦éš”ç¦»
5. âœ… å‘åå…¼å®¹æ€§æ˜¯å¦æ­£å¸¸

---

**çŠ¶æ€**: âœ… æ ¸å¿ƒåŠŸèƒ½å·²å®ç°ï¼Œå¾…éƒ¨ç½²æµ‹è¯•
**ç‰ˆæœ¬**: v2.0.0
**å®Œæˆæ—¶é—´**: 2026-01-17

ä¸‹ä¸€æ­¥è¯·æŒ‰ç…§éƒ¨ç½²æ­¥éª¤è¿›è¡Œéƒ¨ç½²æµ‹è¯•ã€‚
