<!--pages/account/account.wxml-->
<view class="container">
  <scroll-view class="content-scroll" scroll-y>
    <!-- è´¦å·é€‰æ‹©å¡ç‰‡ (iOSé£æ ¼) -->
    <view class="account-select-card">
      <view class="card-header">
        <text class="card-title">å½“å‰è´¦å·</text>
      </view>
      <picker mode="selector" range="{{accountNames}}" value="{{currentAccountIndex}}" bindchange="onAccountChange">
        <view class="account-picker">
          <view class="picker-content">
            <text class="account-name">{{currentAccount.name || 'æœªé€‰æ‹©'}}</text>
            <text class="account-badge {{currentAccount.isSimulation ? 'simulation' : 'real'}}">
              {{currentAccount.isSimulation ? 'æ¨¡æ‹Ÿç›˜' : 'å®ç›˜'}}
            </text>
          </view>
          <text class="picker-arrow">â€º</text>
        </view>
      </picker>
    </view>

    <!-- è´¦æˆ·ä¿¡æ¯å¡ç‰‡ (iOSé£æ ¼) -->
    <view class="info-card">
      <view class="info-row">
        <text class="info-label">UID</text>
        <text class="info-value">{{accountInfo.uid || '--'}}</text>
      </view>
      <view class="info-divider"></view>
      <view class="info-row">
        <text class="info-label">ç­‰çº§</text>
        <text class="info-value">{{accountInfo.level || '--'}}</text>
      </view>
      <view class="info-divider"></view>
      <view class="info-row highlight">
        <text class="info-label">æ€»èµ„äº§</text>
        <text class="info-value large">${{accountInfo.totalEquity || '0.00'}}</text>
      </view>
    </view>

    <!-- èµ„äº§æ˜ç»†å¡ç‰‡ (iOSé£æ ¼) -->
    <view class="section-card">
      <view class="section-header">
        <text class="section-title">ğŸ’° èµ„äº§æ˜ç»†</text>
        <button class="refresh-mini-btn" bindtap="refreshAssets">
          <text class="refresh-icon">â†»</text>
        </button>
      </view>
      <view wx:if="{{balances.length === 0}}" class="empty-row">
        <text class="empty-text">æš‚æ— èµ„äº§</text>
      </view>
      <view wx:else class="balance-list">
        <view class="balance-item" wx:for="{{balances}}" wx:key="currency">
          <view class="balance-left">
            <view class="currency-icon">
              <text class="currency-letter">{{item.currency[0]}}</text>
            </view>
            <text class="currency-name">{{item.currency}}</text>
          </view>
          <view class="balance-right">
            <text class="balance-amount">{{item.totalDisplay}}</text>
            <text class="balance-usd">â‰ˆ ${{item.usdValueDisplay}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- åˆçº¦æŒä»“å¡ç‰‡ (iOSé£æ ¼) -->
    <view class="section-card">
      <view class="section-header">
        <text class="section-title">ğŸ“Š åˆçº¦æŒä»“</text>
        <button class="refresh-mini-btn" bindtap="refreshPositions">
          <text class="refresh-icon">â†»</text>
        </button>
      </view>
      <view wx:if="{{contractPositions.length === 0}}" class="empty-row">
        <text class="empty-text">æš‚æ— åˆçº¦æŒä»“</text>
      </view>
      <view wx:else class="position-list">
        <view class="position-card" wx:for="{{contractPositions}}" wx:key="posId">
          <view class="position-main">
            <view class="position-header">
              <text class="position-symbol">{{item.instId}}</text>
              <view class="position-tags">
                <view class="direction-tag {{item.posSide}}">
                  <text class="tag-text">{{item.posSide === 'long' ? 'å¤š' : 'ç©º'}}</text>
                </view>
                <text class="leverage-text">{{item.lever}}x</text>
              </view>
            </view>
            <view class="position-details">
              <text class="detail-text">æ•°é‡: {{item.pos}}</text>
              <text class="detail-text">å‡ä»·: {{item.avgPxDisplay}}</text>
            </view>
          </view>
          <view class="position-pnl {{item.uplNum >= 0 ? 'profit' : 'loss'}}">
            <text class="pnl-value">{{item.uplNum >= 0 ? '+' : ''}}{{item.uplDisplay}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æœ€è¿‘äº¤æ˜“å¡ç‰‡ (iOSé£æ ¼) -->
    <view class="section-card">
      <view class="section-header">
        <text class="section-title">ğŸ“œ æœ€è¿‘äº¤æ˜“</text>
        <button class="view-more-btn" bindtap="goToHistory">
          <text class="view-more-text">æŸ¥çœ‹æ›´å¤š</text>
          <text class="view-more-arrow">â€º</text>
        </button>
      </view>
      <view wx:if="{{recentTrades.length === 0}}" class="empty-row">
        <text class="empty-text">æš‚æ— äº¤æ˜“è®°å½•</text>
      </view>
      <view wx:else class="trade-list">
        <view class="trade-item" wx:for="{{recentTrades}}" wx:key="id">
          <view class="trade-main">
            <view class="trade-header">
              <text class="trade-symbol">{{item.symbol}}</text>
              <view class="trade-tag {{item.operationClass}}">
                <text class="trade-tag-text">{{item.operationLabel}}</text>
              </view>
            </view>
            <text class="trade-time">{{item.time}}</text>
          </view>
          <view class="trade-pnl {{item.pnl >= 0 ? 'profit' : 'loss'}}" wx:if="{{item.pnl !== 0}}">
            <text class="pnl-text">{{item.pnl >= 0 ? '+' : ''}}{{item.pnlDisplay}}</text>
          </view>
          <text class="trade-size" wx:else>{{item.sizeDisplay}}</text>
        </view>
      </view>
    </view>

    <!-- åŠŸèƒ½å…¥å£ -->
    <view class="features-grid">
      <button class="feature-btn" bindtap="goToMonitor">
        <text class="feature-icon">ğŸ¯</text>
        <text class="feature-text">äº¤æ˜“ç›‘æ§</text>
      </button>
      <button class="feature-btn" bindtap="goToStrategy">
        <text class="feature-icon">âš™ï¸</text>
        <text class="feature-text">ç­–ç•¥ç®¡ç†</text>
      </button>
    </view>

    <!-- åˆ·æ–°æŒ‰é’® -->
    <view class="refresh-section">
      <button class="refresh-all-btn" bindtap="refreshAll" loading="{{isRefreshing}}">
        <text class="btn-icon" wx:if="{{!isRefreshing}}">â†»</text>
        <text class="btn-text">{{isRefreshing ? 'åˆ·æ–°ä¸­...' : 'åˆ·æ–°è´¦æˆ·ä¿¡æ¯'}}</text>
      </button>
    </view>
  </scroll-view>
</view>

<!-- è´¦å·ç®¡ç†æ¨¡æ€æ¡† -->
<view class="modal-mask" wx:if="{{showModal}}" bindtap="closeModal">
  <view class="modal-content" catchtap="">
    <view class="modal-header">
      <text class="modal-title">{{modalMode === 'add' ? 'æ·»åŠ è´¦å·' : 'ç¼–è¾‘è´¦å·'}}</text>
      <text class="modal-close" bindtap="closeModal">âœ•</text>
    </view>

    <view class="modal-body">
      <view class="form-item">
        <text class="form-label">è´¦å·åç§° *</text>
        <input class="form-input"
               placeholder="è¯·è¾“å…¥è´¦å·åç§°"
               value="{{formData.name}}"
               bindinput="onInputChange"
               data-field="name"/>
      </view>

      <view class="form-item">
        <view class="form-row">
          <view class="form-row-left">
            <text class="form-label">æ¨¡æ‹Ÿè´¦å·</text>
            <switch checked="{{formData.isSimulation}}"
                    bindchange="onSimulationChange"
                    color="#667eea"/>
          </view>
          <text class="form-hint">æ¨¡æ‹Ÿè´¦å·æ— éœ€APIå¯†é’¥</text>
        </view>
      </view>

      <view class="form-group" wx:if="{{!formData.isSimulation}}">
        <text class="form-group-title">APIé…ç½®</text>

        <view class="form-item">
          <text class="form-label">API Key *</text>
          <input class="form-input"
                 placeholder="è¯·è¾“å…¥API Key"
                 value="{{formData.apiKey}}"
                 bindinput="onInputChange"
                 data-field="apiKey"/>
        </view>

        <view class="form-item">
          <text class="form-label">Secret Key *</text>
          <input class="form-input"
                 placeholder="è¯·è¾“å…¥Secret Key"
                 value="{{formData.secretKey}}"
                 bindinput="onInputChange"
                 data-field="secretKey"
                 password="true"/>
        </view>

        <view class="form-item">
          <text class="form-label">Passphrase *</text>
          <input class="form-input"
                 placeholder="è¯·è¾“å…¥Passphrase"
                 value="{{formData.passphrase}}"
                 bindinput="onInputChange"
                 data-field="passphrase"
                 password="true"/>
        </view>
      </view>
    </view>

    <view class="modal-footer">
      <button class="modal-btn cancel" bindtap="closeModal">å–æ¶ˆ</button>
      <button class="modal-btn confirm" bindtap="saveAccount">ä¿å­˜</button>
    </view>
  </view>
</view>
