<!--pages/strategy-edit/strategy-edit.wxml-->
<!-- WXS å·¥å…·å‡½æ•° -->
<wxs module="utils">
module.exports = {
  findIndex: function(arr, val, key) {
    for (var i = 0; i < arr.length; i++) {
      if (arr[i][key] === val) return i;
    }
    return 0;
  },
  indexOf: function(arr, val) {
    for (var i = 0; i < arr.length; i++) {
      if (arr[i] === val) return i;
    }
    return 0;
  }
}
</wxs>

<view class="container">
  <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
  <view class="tab-nav">
    <view 
      wx:for="{{tabs}}" 
      wx:key="index" 
      class="tab-item {{currentTab === index ? 'active' : ''}}"
      data-index="{{index}}"
      bindtap="switchTab"
    >
      <text class="tab-text">{{item}}</text>
    </view>
  </view>

  <!-- å†…å®¹åŒºåŸŸ -->
  <scroll-view class="content-scroll" scroll-y>
    <!-- ==================== åŸºç¡€è®¾ç½® ==================== -->
    <view class="tab-content" wx:if="{{currentTab === 0}}">
      <view class="section-card">
        <view class="section-header">
          <text class="section-title">ğŸ“ ç­–ç•¥åç§°</text>
        </view>
        <view class="input-row">
          <input
            class="text-input"
            value="{{basicConfig.strategyName}}"
            placeholder="è¯·è¾“å…¥ç­–ç•¥åç§°"
            placeholder-class="input-placeholder"
            maxlength="30"
            bindinput="onStrategyNameInput"
          />
        </view>
        <text class="section-hint">è‡ªå®šä¹‰åç§°ï¼Œä¾¿äºåŒºåˆ†ä¸åŒç­–ç•¥é…ç½®</text>
      </view>

      <view class="section-card" wx:if="{{templateOptions.length > 0}}">
        <view class="section-header">
          <text class="section-title">ğŸ§© ç­–ç•¥æ¨¡æ¿</text>
        </view>
        <picker
          mode="selector"
          range="{{templateOptions}}"
          range-key="name"
          value="{{utils.findIndex(templateOptions, basicConfig.strategyType, 'value')}}"
          bindchange="onStrategyTypeChange"
        >
          <view class="picker-row">
            <text class="picker-label">æ¨¡æ¿é€‰æ‹©</text>
            <view class="picker-value-wrap">
              <text class="picker-value">{{templateOptions[utils.findIndex(templateOptions, basicConfig.strategyType, 'value')].name}}</text>
              <text class="picker-arrow">â€º</text>
            </view>
          </view>
        </picker>
        <text class="section-hint">{{templateOptions[utils.findIndex(templateOptions, basicConfig.strategyType, 'value')].desc}}</text>
      </view>

      <view class="section-card">
        <view class="section-header">
          <text class="section-title">ğŸ“Š äº¤æ˜“å¯¹</text>
        </view>
        <picker mode="selector" range="{{symbolList}}" value="{{utils.indexOf(symbolList, basicConfig.symbol)}}" bindchange="onSymbolChange">
          <view class="picker-row">
            <text class="picker-label">å½“å‰äº¤æ˜“å¯¹</text>
            <view class="picker-value-wrap">
              <text class="picker-value">{{basicConfig.symbol}}</text>
              <text class="picker-arrow">â€º</text>
            </view>
          </view>
        </picker>
      </view>

      <view class="section-card">
        <view class="section-header">
          <text class="section-title">ğŸ“ˆ äº¤æ˜“æ–¹å‘</text>
        </view>
        <picker mode="selector" range="{{directionList}}" range-key="name" value="{{utils.findIndex(directionList, basicConfig.tradeDirection, 'value')}}" bindchange="onDirectionChange">
          <view class="picker-row">
            <text class="picker-label">æ–¹å‘é™åˆ¶</text>
            <view class="picker-value-wrap">
              <text class="picker-value">{{directionList[utils.findIndex(directionList, basicConfig.tradeDirection, 'value')].name}}</text>
              <text class="picker-arrow">â€º</text>
            </view>
          </view>
        </picker>
        <text class="section-hint">{{directionList[utils.findIndex(directionList, basicConfig.tradeDirection, 'value')].desc}}</text>
      </view>

      <view class="section-card">
        <view class="section-header">
          <text class="section-title">ğŸ• æ—¶é—´é—´éš”</text>
        </view>
        <view class="slider-row">
          <view class="slider-header">
            <text class="slider-label">åˆ†æé—´éš”</text>
            <text class="slider-value">{{basicConfig.analysisInterval}}ç§’</text>
          </view>
          <slider min="10" max="120" step="5" value="{{basicConfig.analysisInterval}}" bindchange="onAnalysisIntervalChange" activeColor="#af52de"/>
        </view>
        <view class="slider-row">
          <view class="slider-header">
            <text class="slider-label">æœ€çŸ­æŒä»“</text>
            <text class="slider-value">{{basicConfig.minHoldSeconds}}ç§’</text>
          </view>
          <slider min="30" max="300" step="10" value="{{basicConfig.minHoldSeconds}}" bindchange="onMinHoldSecondsChange" activeColor="#ff9500"/>
          <text class="slider-hint">å¼€ä»“åè‡³å°‘æŒæœ‰è¯¥æ—¶é—´æ‰å…è®¸å¹³ä»“</text>
        </view>
      </view>

      <!-- âœ… å‡çº§ï¼šäº¤æ˜“æ¨¡å¼é€‰æ‹© -->
      <view class="section-card">
        <view class="section-header">
          <text class="section-title">ğŸ¯ äº¤æ˜“æ¨¡å¼</text>
        </view>
        <view class="mode-toggle">
          <view class="mode-card {{basicConfig.tradingMode === 'ai' ? 'active' : ''}}" data-mode="ai" bindtap="onTradingModeSelect">
            <view class="mode-card-header">
              <text class="mode-title">AI è¾…åŠ©</text>
              <text class="mode-badge ai">AI</text>
            </view>
            <text class="mode-sub">æ™ºèƒ½åˆ†æï¼Œç»¼åˆå¤šæŒ‡æ ‡</text>
            <view class="mode-points">
              <text class="mode-point">é€‚åˆç­–ç•¥éªŒè¯</text>
              <text class="mode-point">å«AIæˆæœ¬</text>
            </view>
          </view>
          <view class="mode-card {{basicConfig.tradingMode === 'pure' ? 'active' : ''}}" data-mode="pure" bindtap="onTradingModeSelect">
            <view class="mode-card-header">
              <text class="mode-title">çº¯ç­–ç•¥</text>
              <text class="mode-badge pure">PURE</text>
            </view>
            <text class="mode-sub">ç›´æ¥æ‰§è¡ŒSARä¿¡å·</text>
            <view class="mode-points">
              <text class="mode-point">æé€Ÿå“åº”</text>
              <text class="mode-point">é›¶AIæˆæœ¬</text>
            </view>
          </view>
        </view>
        <view class="mode-footer">
          <text class="mode-tip">å½“å‰é€‰æ‹©ï¼š{{basicConfig.tradingMode === 'pure' ? 'çº¯ç­–ç•¥æ¨¡å¼' : 'AIè¾…åŠ©æ¨¡å¼'}}</text>
        </view>
      </view>
    </view>

    <!-- ==================== å¼€ä»“æ¡ä»¶ ==================== -->
    <view class="tab-content" wx:if="{{currentTab === 1}}">
      <view class="section-card">
        <view class="section-header">
          <text class="section-title">ğŸ”— æ¡ä»¶é€»è¾‘</text>
        </view>
        <view class="switch-row">
          <view class="switch-info">
            <text class="switch-label">{{buyConfig.logicType === 'and' ? 'AND (å…¨éƒ¨æ»¡è¶³)' : 'OR (ä»»ä¸€æ»¡è¶³)'}}</text>
            <text class="switch-desc">{{buyConfig.logicType === 'and' ? 'æ‰€æœ‰å¯ç”¨æ¡ä»¶åŒæ—¶æ»¡è¶³æ‰å¼€ä»“' : 'ä»»ä¸€æ¡ä»¶æ»¡è¶³å³å¯å¼€ä»“'}}</text>
          </view>
          <switch checked="{{buyConfig.logicType === 'and'}}" bindchange="onBuyLogicChange" color="#af52de"/>
        </view>
      </view>

      <!-- å¼€ä»“æ¡ä»¶ -->
      <view class="section-card long-conditions">
        <view class="section-header">
          <text class="section-title">ğŸ“ˆ å¼€ä»“æ¡ä»¶ ({{buyConfig.logicType === 'and' ? 'AND' : 'OR'}}é€»è¾‘)</text>
        </view>
        <text class="section-hint green-text">
          {{buyConfig.logicType === 'and' ? 'ä»¥ä¸‹æ‰€æœ‰æ¡ä»¶åŒæ—¶æ»¡è¶³æ—¶å…è®¸å¼€ä»“' : 'ä»¥ä¸‹ä»»ä¸€æ¡ä»¶æ»¡è¶³æ—¶å…è®¸å¼€ä»“'}}
        </text>
        <view class="condition-list">
          <view
            wx:for="{{buyConfig.conditions}}"
            wx:key="id"
            class="condition-item {{item.enabled ? 'enabled' : 'disabled'}}"
            data-index="{{index}}"
            bindtap="onBuyConditionToggle"
          >
            <view class="condition-left">
              <view class="condition-checkbox {{item.enabled ? 'checked' : ''}}">
                <text wx:if="{{item.enabled}}">âœ“</text>
              </view>
              <view class="condition-info">
                <text class="condition-name">{{item.name}}</text>
                <text class="condition-desc">{{item.desc}}</text>
              </view>
            </view>
            <text class="condition-timeframe">{{item.timeframe}}</text>
          </view>
        </view>
      </view>


    </view>

    <!-- ==================== å¹³ä»“æ¡ä»¶ ==================== -->
    <view class="tab-content" wx:if="{{currentTab === 2}}">
      <!-- æ¡ä»¶é€»è¾‘è¯´æ˜ -->
      <view class="section-card">
        <view class="section-header">
          <text class="section-title">ğŸ”— æ¡ä»¶é€»è¾‘</text>
        </view>
        <view class="logic-info-row">
          <view class="logic-badge or">OR</view>
          <view class="logic-info">
            <text class="logic-label">æ»¡è¶³ä»»ä¸€å³å¯å¹³ä»“</text>
            <text class="logic-desc">ä»¥ä¸‹ä»»ä¸€æ¡ä»¶æ»¡è¶³æ—¶ä¼šè§¦å‘å¹³ä»“</text>
          </view>
        </view>
      </view>

      <view class="section-card">
        <view class="section-header">
          <text class="section-title">ğŸ›¡ï¸ æ­¢ç›ˆæ­¢æŸ</text>
        </view>
        <view class="compact-row">
          <text class="compact-label red-text">æ­¢æŸ</text>
          <view class="compact-right">
            <text class="compact-value {{sellConfig.stopLossEnabled ? 'red-text' : 'muted-text'}}">
              {{sellConfig.stopLossEnabled ? (sellConfig.stopLossPercent + '%') : 'å·²å…³é—­'}}
            </text>
            <switch checked="{{sellConfig.stopLossEnabled}}" bindchange="onStopLossEnabledChange" color="#ff3b30"/>
          </view>
        </view>
        <view class="slider-row compact-slider" wx:if="{{sellConfig.stopLossEnabled}}">
          <slider min="0.5" max="10" step="0.5" value="{{sellConfig.stopLossPercent}}" bindchange="onStopLossPercentChange" activeColor="#ff3b30"/>
        </view>

        <view class="compact-row">
          <text class="compact-label green-text">æ­¢ç›ˆ</text>
          <view class="compact-right">
            <text class="compact-value {{sellConfig.takeProfitEnabled ? 'green-text' : 'muted-text'}}">
              {{sellConfig.takeProfitEnabled ? (sellConfig.takeProfitPercent + '%') : 'å·²å…³é—­'}}
            </text>
            <switch checked="{{sellConfig.takeProfitEnabled}}" bindchange="onTakeProfitEnabledChange" color="#34c759"/>
          </view>
        </view>
        <view class="slider-row compact-slider" wx:if="{{sellConfig.takeProfitEnabled}}">
          <slider min="1" max="50" step="1" value="{{sellConfig.takeProfitPercent}}" bindchange="onTakeProfitPercentChange" activeColor="#34c759"/>
        </view>
      </view>

      <!-- å¹³ä»“æ¡ä»¶ -->
      <view class="section-card">
        <view class="section-header">
          <text class="section-title">ğŸ“¤ å¹³ä»“æ¡ä»¶ (ORé€»è¾‘)</text>
        </view>
        <text class="section-hint">ä»¥ä¸‹ä»»ä¸€æ¡ä»¶æ»¡è¶³æ—¶å¹³ä»“</text>
        <view class="condition-list">
          <view
            wx:for="{{sellConfig.conditions}}"
            wx:key="id"
            wx:if="{{item.indicator}}"
            class="condition-item {{item.enabled ? 'enabled' : 'disabled'}}"
            data-id="{{item.id}}"
            bindtap="toggleSellCondition"
          >
            <view class="condition-left">
              <view class="condition-checkbox {{item.enabled ? 'checked' : ''}}">
                <text wx:if="{{item.enabled}}">âœ“</text>
              </view>
              <view class="condition-info">
                <text class="condition-name">{{item.name}}</text>
                <text class="condition-desc">{{item.desc}}</text>
              </view>
            </view>
            <text class="condition-timeframe">{{item.timeframe}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- ==================== èµ„é‡‘ç®¡ç† ==================== -->
    <view class="tab-content" wx:if="{{currentTab === 3}}">
      <view class="section-card">
        <view class="section-header">
          <text class="section-title">ğŸ’µ èµ„é‡‘æ¨¡å¼</text>
        </view>
        <picker mode="selector" range="{{modeList}}" range-key="name" value="{{utils.findIndex(modeList, fundConfig.mode, 'value')}}" bindchange="onFundModeChange">
          <view class="picker-row">
            <text class="picker-label">èµ„é‡‘æ¨¡å¼</text>
            <view class="picker-value-wrap">
              <text class="picker-value">{{modeList[utils.findIndex(modeList, fundConfig.mode, 'value')].name}}</text>
              <text class="picker-arrow">â€º</text>
            </view>
          </view>
        </picker>
        <text class="section-hint">{{modeList[utils.findIndex(modeList, fundConfig.mode, 'value')].desc}}</text>
      </view>

      <view class="section-card" wx:if="{{fundConfig.mode === 'fixed'}}">
        <view class="section-header">
          <text class="section-title">ğŸ’° å›ºå®šé‡‘é¢</text>
        </view>
        <view class="slider-row">
          <view class="slider-header">
            <text class="slider-label">æ¯æ¬¡äº¤æ˜“é‡‘é¢</text>
            <text class="slider-value">{{fundConfig.fixedAmount}} USDT</text>
          </view>
          <slider min="10" max="500" step="10" value="{{fundConfig.fixedAmount}}" bindchange="onFixedAmountChange" activeColor="#af52de"/>
        </view>
      </view>

      <view class="section-card" wx:if="{{fundConfig.mode === 'balance'}}">
        <view class="section-header">
          <text class="section-title">ğŸ“Š è´¦æˆ·æ¯”ä¾‹</text>
        </view>
        <view class="slider-row">
          <view class="slider-header">
            <text class="slider-label">ä½™é¢ä½¿ç”¨æ¯”ä¾‹</text>
            <text class="slider-value">{{fundConfig.balancePercent}}%</text>
          </view>
          <slider min="5" max="100" step="5" value="{{fundConfig.balancePercent}}" bindchange="onBalancePercentChange" activeColor="#af52de"/>
        </view>
      </view>

      <view class="section-card">
        <view class="section-header">
          <text class="section-title">ğŸ“ˆ æ æ†è®¾ç½®</text>
        </view>
        <view class="slider-row">
          <view class="slider-header">
            <text class="slider-label">æ æ†å€æ•°</text>
            <text class="slider-value orange">{{fundConfig.leverage}}x</text>
          </view>
          <slider min="1" max="20" step="1" value="{{fundConfig.leverage}}" bindchange="onLeverageChange" activeColor="#ff9500"/>
          <text class="slider-hint">é«˜æ æ† = é«˜é£é™©ï¼Œå»ºè®®æ–°æ‰‹ä½¿ç”¨ 5x ä»¥ä¸‹</text>
        </view>
      </view>

      <view class="section-card">
        <view class="section-header">
          <text class="section-title">ğŸ¦ ä¿è¯é‡‘æ¨¡å¼</text>
        </view>
        <picker mode="selector" range="{{marginModeList}}" range-key="name" value="{{utils.findIndex(marginModeList, fundConfig.marginMode, 'value')}}" bindchange="onMarginModeChange">
          <view class="picker-row">
            <text class="picker-label">æ¨¡å¼é€‰æ‹©</text>
            <view class="picker-value-wrap">
              <text class="picker-value">{{marginModeList[utils.findIndex(marginModeList, fundConfig.marginMode, 'value')].name}}</text>
              <text class="picker-arrow">â€º</text>
            </view>
          </view>
        </picker>
        <text class="section-hint">{{marginModeList[utils.findIndex(marginModeList, fundConfig.marginMode, 'value')].desc}}</text>
      </view>

      <view class="section-card">
        <view class="section-header">
          <text class="section-title">ğŸ“¦ æŒä»“é™åˆ¶</text>
        </view>
        <view class="slider-row">
          <view class="slider-header">
            <text class="slider-label">æœ€å¤§æŒä»“æ•°</text>
            <text class="slider-value">{{fundConfig.maxPositions}}</text>
          </view>
          <slider min="1" max="10" step="1" value="{{fundConfig.maxPositions}}" bindchange="onMaxPositionsChange" activeColor="#af52de"/>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
    <view class="bottom-actions">
      <button class="action-btn reset" bindtap="resetToDefault">
        <text class="btn-icon">â†º</text>
        <text class="btn-text">æ¢å¤é»˜è®¤</text>
      </button>
      <button class="action-btn save" bindtap="handleSaveTap" loading="{{saving}}">
        <text class="btn-icon" wx:if="{{!saving}}">ğŸ’¾</text>
        <text class="btn-text">{{saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜ç­–ç•¥'}}</text>
      </button>
    </view>

    <!-- å®‰å…¨åŒº -->
    <view class="safe-bottom"></view>
  </scroll-view>
</view>
