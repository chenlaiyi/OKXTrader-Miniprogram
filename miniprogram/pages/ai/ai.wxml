<!--pages/ai/ai.wxml-->
<view class="container">
  <!-- é¡¶éƒ¨é€‰æ‹©å™¨ -->
  <view class="symbol-selector">
    <view class="selector-label">åˆ†æå¯¹è±¡</view>
    <picker class="symbol-picker" mode="selector" range="{{symbols}}" value="{{selectedIndex}}" bindchange="onSymbolChange">
      <view class="picker-display">
        <text class="symbol-text">{{currentSymbol}}</text>
        <text class="picker-arrow">â–¼</text>
      </view>
    </picker>
  </view>

  <!-- æœ€æ–°åˆ†æå¡ç‰‡ -->
  <view class="analysis-card" wx:if="{{latestAnalysis}}">
    <!-- ä¿¡å·æ ‡è¯† -->
    <view class="signal-header">
      <view class="signal-badge {{latestAnalysis.signal_type}}">
        <text class="signal-icon">{{latestAnalysis.signal_type === 'long' ? 'ğŸ“ˆ' : latestAnalysis.signal_type === 'short' ? 'ğŸ“‰' : 'â¸'}}</text>
        <view class="signal-info">
          <text class="signal-text">{{latestAnalysis.signal_type === 'long' ? 'åšå¤šä¿¡å·' : latestAnalysis.signal_type === 'short' ? 'åšç©ºä¿¡å·' : 'è§‚æœ›ä¿¡å·'}}</text>
          <text class="signal-strength">å¼ºåº¦: {{latestAnalysis.strength || 'ä¸­ç­‰'}}</text>
        </view>
      </view>

      <view class="confidence-wrapper">
        <text class="confidence-label">AIç½®ä¿¡åº¦</text>
        <view class="confidence-value">
          <text class="confidence-number">{{latestAnalysis.confidence_display || '85'}}</text>
          <text class="confidence-percent">%</text>
        </view>
      </view>
    </view>

    <!-- ç½®ä¿¡åº¦è¿›åº¦æ¡ -->
    <view class="confidence-bar-wrapper">
      <view class="bar-bg">
        <view class="bar-fill" style="width: {{latestAnalysis.confidence_display || 85}}%"></view>
      </view>
      <view class="bar-labels">
        <text class="bar-label">ä½</text>
        <text class="bar-label">ä¸­</text>
        <text class="bar-label">é«˜</text>
      </view>
    </view>

    <!-- ä»·æ ¼å»ºè®® -->
    <view class="price-suggestions" wx:if="{{latestAnalysis.suggested_price || latestAnalysis.stop_loss || latestAnalysis.take_profit}}">
      <view class="price-item" wx:if="{{latestAnalysis.suggested_price}}">
        <text class="price-label">å»ºè®®å…¥åœºä»·</text>
        <text class="price-value">{{latestAnalysis.suggested_price}}</text>
      </view>
      <view class="price-item" wx:if="{{latestAnalysis.stop_loss}}">
        <text class="price-label">æ­¢æŸä»·æ ¼</text>
        <text class="price-value loss">{{latestAnalysis.stop_loss}}</text>
      </view>
      <view class="price-item" wx:if="{{latestAnalysis.take_profit}}">
        <text class="price-label">æ­¢ç›ˆä»·æ ¼</text>
        <text class="price-value profit">{{latestAnalysis.take_profit}}</text>
      </view>
    </view>

    <!-- åˆ†æç†ç”± -->
    <view class="reasoning-section">
      <view class="section-title">
        <text class="title-icon">ğŸ’¡</text>
        <text class="title-text">åˆ†æç†ç”±</text>
      </view>
      <view class="reasoning-content">{{latestAnalysis.reasoning}}</view>
    </view>

    <!-- æŒä»“åˆ†æ -->
    <view class="position-analysis" wx:if="{{latestAnalysis.position_analysis}}">
      <view class="section-title">
        <text class="title-icon">ğŸ“Š</text>
        <text class="title-text">æŒä»“åˆ†æ</text>
      </view>
      <view class="analysis-content">{{latestAnalysis.position_analysis}}</view>
    </view>

    <!-- é£é™©æç¤º -->
    <view class="risks-section" wx:if="{{latestAnalysis.risks && latestAnalysis.risks.length > 0}}">
      <view class="section-title">
        <text class="title-icon">âš ï¸</text>
        <text class="title-text">é£é™©æç¤º</text>
      </view>
      <view class="risks-list">
        <view class="risk-item" wx:for="{{latestAnalysis.risks}}" wx:key="index">
          <text class="risk-bullet">â€¢</text>
          <text class="risk-text">{{item}}</text>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨ä¿¡æ¯ -->
    <view class="analysis-footer">
      <view class="timestamp">
        <text class="time-icon">ğŸ•</text>
        <text class="time-text">{{formatTime(latestAnalysis.timestamp)}}</text>
      </view>
      <button class="action-btn" bindtap="applyAnalysis">åº”ç”¨æ­¤ç­–ç•¥</button>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:else>
    <view class="empty-icon">ğŸ¤–</view>
    <view class="empty-text">æš‚æ— AIåˆ†æ</view>
    <view class="empty-hint">è¯·å…ˆé€‰æ‹©äº¤æ˜“å¯¹å¹¶ç­‰å¾…AIåˆ†æ</view>
  </view>

  <!-- æŠ€æœ¯æŒ‡æ ‡ -->
  <view class="indicators-section">
    <view class="section-header">
      <view class="header-icon">ğŸ“ˆ</view>
      <view class="header-title">æŠ€æœ¯æŒ‡æ ‡</view>
    </view>

    <view class="indicators-grid">
      <view class="indicator-item">
        <text class="indicator-label">RSI</text>
        <text class="indicator-value {{indicators.rsi_level || 'neutral'}}">{{indicators.ri || '--'}}</text>
      </view>
      <view class="indicator-item">
        <text class="indicator-label">MACD</text>
        <text class="indicator-value {{indicators.macd_signal || 'neutral'}}">{{indicators.macd || '--'}}</text>
      </view>
      <view class="indicator-item">
        <text class="indicator-label">MA</text>
        <text class="indicator-value {{indicators.ma_trend || 'neutral'}}">{{indicators.ma || '--'}}</text>
      </view>
      <view class="indicator-item">
        <text class="indicator-label">å¸ƒæ—å¸¦</text>
        <text class="indicator-value {{indicators.bb_position || 'neutral'}}">{{indicators.bollinger || '--'}}</text>
      </view>
    </view>
  </view>

  <!-- å†å²åˆ†æ -->
  <view class="history-section">
    <view class="section-header">
      <view class="header-icon">ğŸ“œ</view>
      <view class="header-title">å†å²åˆ†æ</view>
      <view class="header-count">{{analysisHistory.length}}</view>
    </view>

    <scroll-view class="history-list" scroll-y>
      <view wx:if="{{analysisHistory.length === 0}}" class="history-empty">
        <text class="empty-text">æš‚æ— å†å²è®°å½•</text>
      </view>

      <view class="history-item" wx:for="{{analysisHistory}}" wx:key="id" bindtap="viewHistoryDetail" data-id="{{item.id}}">
        <view class="history-left">
          <view class="history-symbol">{{item.symbol}}</view>
          <view class="history-time">{{formatTime(item.timestamp)}}</view>
        </view>
        <view class="history-right">
          <view class="history-signal {{item.signal_type}}">
            <text class="signal-mini">{{item.signal_type === 'long' ? 'å¤š' : item.signal_type === 'short' ? 'ç©º' : 'è§‚'}}</text>
          </view>
          <view class="history-confidence">{{item.confidence}}%</view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- åº•éƒ¨æç¤º -->
  <view class="footer-hint">
    <text class="hint-text">AIåˆ†æä»…ä¾›å‚è€ƒï¼ŒæŠ•èµ„éœ€è°¨æ…</text>
  </view>
</view>
