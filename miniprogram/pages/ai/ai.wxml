<!--pages/ai/ai.wxml-->
<view class="container">
  <!-- ç­–ç•¥çŠ¶æ€æ  (iOSé£æ ¼) - ç‚¹å‡»è¿›å…¥ç­–ç•¥é…ç½® -->
  <view class="strategy-status-bar" bindtap="goToStrategyEdit">
    <view class="strategy-left">
      <text class="strategy-emoji">{{currentStrategy.emoji}}</text>
      <view class="strategy-info">
        <text class="strategy-label">å½“å‰ç­–ç•¥</text>
        <text class="strategy-name">{{currentStrategy.name}}</text>
      </view>
    </view>
    <view class="strategy-right">
      <view class="style-badge {{tradingStyle === 'aggressive' ? 'aggressive' : 'conservative'}}">
        <text class="style-icon">{{tradingStyle === 'aggressive' ? 'ğŸ”¥' : 'ğŸ›¡ï¸'}}</text>
        <text class="style-text">{{tradingStyle === 'aggressive' ? 'æ¿€è¿›' : 'ç¨³å¥'}}</text>
      </view>
      <text class="edit-arrow">â€º</text>
    </view>
  </view>

  <!-- è‡ªåŠ¨äº¤æ˜“å¼€å…³ï¼ˆæœåŠ¡å™¨ç«¯24å°æ—¶è¿è¡Œï¼‰ -->
  <view class="auto-trade-card">
    <view class="auto-trade-info">
      <text class="auto-icon">ğŸ¤–</text>
      <view class="auto-trade-text">
        <text class="auto-label">24å°æ—¶è‡ªåŠ¨äº¤æ˜“</text>
        <text class="auto-desc">{{autoTradeEnabled ? 'æœåŠ¡å™¨è¿è¡Œä¸­ï¼Œç¦»å¼€é¡µé¢ä¹Ÿä¼šè‡ªåŠ¨äº¤æ˜“' : 'å¼€å¯åæœåŠ¡å™¨å°†è‡ªåŠ¨åˆ†æå¹¶æ‰§è¡Œäº¤æ˜“'}}</text>
      </view>
    </view>
    <switch
      checked="{{autoTradeEnabled}}"
      bindchange="toggleAutoTrade"
      color="#af52de"
    />
  </view>

  <!-- äº¤æ˜“ç»Ÿè®¡ï¼ˆä»…è‡ªåŠ¨äº¤æ˜“å¼€å¯æ—¶æ˜¾ç¤ºï¼‰ -->
  <view class="auto-stats-card" wx:if="{{autoTradeEnabled && autoTradingStats.totalTrades > 0}}">
    <view class="stats-row">
      <view class="stat-item">
        <text class="stat-value">{{autoTradingStats.totalTrades}}</text>
        <text class="stat-label">æ€»äº¤æ˜“</text>
      </view>
      <view class="stat-item green">
        <text class="stat-value">{{autoTradingStats.winTrades}}</text>
        <text class="stat-label">ç›ˆåˆ©</text>
      </view>
      <view class="stat-item red">
        <text class="stat-value">{{autoTradingStats.lossTrades}}</text>
        <text class="stat-label">äºæŸ</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{autoTradingStats.winRate}}%</text>
        <text class="stat-label">èƒœç‡</text>
      </view>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’® -->
  <view class="action-buttons" wx:if="{{!isPureMode}}">
    <button
      class="action-btn primary"
      bindtap="startAnalysis"
      disabled="{{isAnalyzing}}"
    >
      <text class="btn-icon" wx:if="{{!isAnalyzing}}">âœ¨</text>
      <text class="btn-text">{{isAnalyzing ? 'åˆ†æä¸­...' : 'AIåˆ†æ'}}</text>
    </button>
    <button
      class="action-btn {{autoAnalysisEnabled ? 'danger' : 'success'}}"
      bindtap="toggleAutoAnalysis"
    >
      <text class="btn-icon">{{autoAnalysisEnabled ? 'â¹' : 'â–¶ï¸'}}</text>
      <text class="btn-text">{{autoAnalysisEnabled ? 'åœæ­¢ç›‘æ§' : 'å®æ—¶ç›‘æ§'}}</text>
    </button>
  </view>

  <!-- è‡ªåŠ¨åˆ·æ–°çŠ¶æ€æç¤º -->
  <view class="auto-refresh-status">
    <text class="refresh-icon">ğŸ”„</text>
    <text class="refresh-text">è‡ªåŠ¨åˆ·æ–°ä¸­</text>
    <text class="refresh-interval">(10ç§’)</text>
  </view>

  <view class="pure-mode-tip" wx:if="{{isPureMode}}">
    <text class="pure-mode-text">çº¯ç­–ç•¥æ¨¡å¼å·²å¼€å¯ï¼ŒAIåˆ†æå†…å®¹å·²éšè—ï¼ˆå†å²ä¸æŒä»“ä»å¯æŸ¥çœ‹ï¼‰</text>
  </view>

  <!-- æ»šåŠ¨å†…å®¹åŒº -->
  <scroll-view class="content-scroll" scroll-y>
    <!-- å½“å‰åˆ†æç»“æœ (åŒä¿¡å·æ˜¾ç¤º - iOSé£æ ¼) -->
    <view class="analysis-result" wx:if="{{!isPureMode && currentAnalysis}}">
      <view class="analysis-header">
        <text class="analysis-title">ğŸ“Š æœ€æ–°åˆ†æ</text>
        <text class="analysis-time">{{analysisTime}}</text>
      </view>
      
      <!-- åˆçº¦ä¿¡å· + ç½®ä¿¡åº¦ -->
      <view class="signal-confidence-row">
        <view class="dual-signal-section">
          <view class="signal-card contract-only">
            <text class="signal-label">åˆçº¦ä¿¡å·</text>
            <view class="signal-pill {{currentAnalysis.contractSignalClass}}">
              <text class="signal-pill-text">{{currentAnalysis.contractSignalText}}</text>
            </view>
          </view>
        </view>
        <view class="confidence-card">
          <text class="confidence-label">ç½®ä¿¡åº¦</text>
          <text class="confidence-value {{currentAnalysis.confidence >= 70 ? 'high' : 'medium'}}">{{currentAnalysis.confidence}}%</text>
        </view>
      </view>
      
      <view class="divider"></view>
      
      <!-- ä»·æ ¼å»ºè®® -->
      <view class="price-suggestions" wx:if="{{currentAnalysis.suggestedPrice || currentAnalysis.stopLoss || currentAnalysis.takeProfit}}">
        <view class="price-item" wx:if="{{currentAnalysis.suggestedPrice}}">
          <text class="price-label">å…¥åœºä»·</text>
          <text class="price-value blue">${{currentAnalysis.suggestedPrice}}</text>
        </view>
        <view class="price-item" wx:if="{{currentAnalysis.stopLoss}}">
          <text class="price-label">æ­¢æŸ</text>
          <text class="price-value red">${{currentAnalysis.stopLoss}}</text>
        </view>
        <view class="price-item" wx:if="{{currentAnalysis.takeProfit}}">
          <text class="price-label">æ­¢ç›ˆ</text>
          <text class="price-value green">${{currentAnalysis.takeProfit}}</text>
        </view>
      </view>
      
      <view class="divider" wx:if="{{currentAnalysis.suggestedPrice}}"></view>
      
      <!-- åˆ†æç†ç”± -->
      <view class="reasoning-section">
        <text class="reasoning-title">ğŸ’¡ åˆ†æç†ç”±</text>
        <text class="reasoning-text">{{currentAnalysis.reasoning}}</text>
      </view>
      
      <!-- æŒä»“åˆ†æï¼ˆä¸Macç«¯ä¸€è‡´ï¼‰ -->
      <view class="position-analysis-section" wx:if="{{currentAnalysis.positionAnalysis}}">
        <view class="divider"></view>
        <text class="position-analysis-title">ğŸ“ æŒä»“åˆ†æ</text>
        <text class="position-analysis-text">{{currentAnalysis.positionAnalysis}}</text>
      </view>
      
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!isPureMode && !currentAnalysis}}">
      <text class="empty-icon">ğŸ“Š</text>
      <text class="empty-text">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹ AI åˆ†æ</text>
    </view>

    <!-- æŒä»“åŒºåŸŸ -->
    <view class="positions-section">
      <view class="section-header">
        <text class="section-title">ğŸ“ å½“å‰æŒä»“ ({{apiPositions.length}})</text>
        <button class="mini-btn" bindtap="refreshPositions">
          <text class="mini-icon">â†»</text>
        </button>
      </view>

      <!-- æœ‰æŒä»“æ—¶æ˜¾ç¤ºåˆ—è¡¨ -->
      <view class="position-list" wx:if="{{apiPositions.length > 0}}">
        <view class="position-item" wx:for="{{apiPositions}}" wx:key="instId">
          <view class="position-direction {{item.side}}">
            <text class="direction-icon">{{item.side === 'long' ? 'ğŸ“ˆ' : 'ğŸ“‰'}}</text>
            <text class="direction-text">{{item.side === 'long' ? 'å¤š' : 'ç©º'}}</text>
          </view>
          <view class="position-info">
            <view class="position-header">
              <text class="position-symbol">{{item.instId}}</text>
              <text class="position-leverage">{{item.leverage}}x</text>
            </view>
            <view class="position-details">
              <text class="position-detail">æ•°é‡: {{item.quantity}}</text>
              <text class="position-detail">å‡ä»·: {{item.avgPrice}}</text>
            </view>
            <view class="position-meta" wx:if="{{item.entryTime}}">
              <text class="position-time">â± {{item.entryTime}}</text>
            </view>
          </view>
          <view class="position-pnl {{item.pnl >= 0 ? 'profit' : 'loss'}}">
            <text class="pnl-label">ç›ˆäº</text>
            <text class="pnl-amount">{{item.pnl >= 0 ? '+' : ''}}{{item.pnl}}</text>
            <text class="pnl-percent">({{item.pnlPercent}})</text>
          </view>
        </view>
      </view>

      <!-- æ— æŒä»“æ—¶æ˜¾ç¤ºç©ºçŠ¶æ€ -->
      <view class="empty-position" wx:else>
        <text class="empty-icon">ğŸ“­</text>
        <text class="empty-text">æš‚æ— æŒä»“</text>
        <text class="empty-hint">ç‚¹å‡»åˆ·æ–°æŒ‰é’®è·å–æœ€æ–°æ•°æ®</text>
      </view>
    </view>

    <!-- åˆ†æå†å² -->
    <view class="history-section">
      <view class="history-header">
        <text class="history-title">ğŸ“œ {{isPureMode ? 'äº¤æ˜“è®°å½•' : 'åˆ†æå†å²'}}</text>
        <text class="history-count" wx:if="{{pagination}}">å…±{{pagination.total}}æ¡</text>
      </view>
      <view class="history-stats-bar" wx:if="{{historyList.length > 0}}">
        <view class="stat-item">
          <text class="stat-dot green"></text>
          <view class="stat-right">
            <text class="stat-text">ä¹°</text>
            <text class="stat-num green">{{buyCount}}</text>
          </view>
        </view>
        <view class="stat-item">
          <text class="stat-dot red"></text>
          <view class="stat-right">
            <text class="stat-text">å–</text>
            <text class="stat-num red">{{sellCount}}</text>
          </view>
        </view>
        <view class="stat-item">
          <text class="stat-dot yellow"></text>
          <view class="stat-right">
            <text class="stat-text">è§‚æœ›</text>
            <text class="stat-num yellow">{{holdCount}}</text>
          </view>
        </view>
      </view>
        <view class="history-list">
        <view class="history-item" wx:for="{{historyList}}" wx:key="id" bindtap="viewHistoryDetail" data-item="{{item}}">
          <text class="history-time">{{item.time}}</text>
          <text class="history-symbol">{{item.symbol}}</text>
          <text class="history-strategy {{item.strategyClass}}">{{item.strategyLabel}}</text>
          <text class="history-signal {{item.signalClass}}">{{item.signalText}}</text>
          <text class="history-confidence {{item.confidence >= 70 ? 'high' : item.confidence >= 50 ? 'medium' : 'low'}}">{{item.confidence}}%</text>
          <text class="history-arrow">â€º</text>
        </view>
      </view>
      <!-- åˆ†é¡µæ§ä»¶ -->
      <view class="pagination-container" wx:if="{{pagination && pagination.totalPages > 1}}">
        <view class="pagination-info">
          <text class="page-text">{{pagination.page}}/{{pagination.totalPages}}</text>
          <text class="total-text">å…±{{pagination.total}}æ¡</text>
        </view>
        <view class="pagination-controls">
          <button
            class="page-btn {{pagination.page <= 1 ? 'disabled' : ''}}"
            bindtap="prevPage"
            disabled="{{pagination.page <= 1}}"
          >
            <text class="btn-icon">â€¹</text>
            <text class="btn-text">ä¸Šä¸€é¡µ</text>
          </button>
          <button
            class="page-btn {{!pagination.hasMore ? 'disabled' : ''}}"
            bindtap="nextPage"
            disabled="{{!pagination.hasMore}}"
          >
            <text class="btn-text">ä¸‹ä¸€é¡µ</text>
            <text class="btn-icon">â€º</text>
          </button>
        </view>
      </view>
    </view>
  </scroll-view>

</view>
