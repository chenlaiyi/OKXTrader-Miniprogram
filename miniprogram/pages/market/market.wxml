<!--pages/market/market.wxml-->
<view class="container">
  <!-- ç§‘æŠ€æ„Ÿåˆ·æ–°åŠ¨ç”» -->
  <view class="tech-refresh-overlay {{refreshing ? 'active' : ''}}" wx:if="{{refreshing}}">
    <view class="tech-spinner">
      <view class="tech-ring outer"></view>
      <view class="tech-ring middle"></view>
      <view class="tech-ring inner"></view>
      <view class="tech-core"></view>
    </view>
    <text class="refresh-text">æ•°æ®åŒæ­¥ä¸­...</text>
  </view>

  <!-- é¡¶éƒ¨å¸ç§Tabåˆ‡æ¢æ  -->
  <view class="coin-tabs-wrapper">
    <scroll-view class="coin-tabs-scroll" scroll-x enable-flex>
      <view class="coin-tabs">
        <view
          class="coin-tab {{selectedPair.baseCcy === item.baseCcy ? 'active' : ''}}"
          wx:for="{{pairs}}"
          wx:key="instId"
          bindtap="selectPair"
          data-pair="{{item}}"
        >
          <text class="coin-name">{{item.baseCcy}}</text>
          <view class="coin-indicator" wx:if="{{selectedPair.baseCcy === item.baseCcy}}">
            <view class="indicator-dot"></view>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- å½“å‰äº¤æ˜“å¯¹ä»·æ ¼å¡ç‰‡ -->
  <view class="price-card" wx:if="{{selectedPair && !loading}}">
    <view class="price-header">
      <view class="price-left">
        <text class="current-price {{priceChangeClass}}">{{currentPrice}}</text>
        <view class="price-change-row">
          <text class="price-change {{priceChangeClass}}">{{priceChangeDisplay}}</text>
          <text class="price-percent {{priceChangeClass}}">{{priceChangePercentDisplay}}</text>
        </view>
      </view>
      <view class="price-right">
        <view class="stat-mini">
          <text class="stat-mini-label">é«˜</text>
          <text class="stat-mini-value">{{high24h}}</text>
        </view>
        <view class="stat-mini">
          <text class="stat-mini-label">ä½</text>
          <text class="stat-mini-value">{{low24h}}</text>
        </view>
        <view class="stat-mini">
          <text class="stat-mini-label">é‡</text>
          <text class="stat-mini-value">{{volume24h}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- Kçº¿å›¾åŒºåŸŸ -->
  <view class="chart-section">
    <!-- æ—¶é—´å‘¨æœŸé€‰æ‹©å™¨å’ŒæŒ‡æ ‡å¼€å…³ -->
    <view class="chart-controls-row">
      <!-- æ—¶é—´å‘¨æœŸé€‰æ‹©å™¨ -->
      <view class="time-period-selector">
        <view
          class="period-item {{timePeriod === '1m' ? 'active' : ''}}"
          bindtap="switchTimePeriod"
          data-period="1m"
        >1m</view>
        <view
          class="period-item {{timePeriod === '5m' ? 'active' : ''}}"
          bindtap="switchTimePeriod"
          data-period="5m"
        >5m</view>
        <view
          class="period-item {{timePeriod === '15m' ? 'active' : ''}}"
          bindtap="switchTimePeriod"
          data-period="15m"
        >15m</view>
        <view
          class="period-item {{timePeriod === '1H' ? 'active' : ''}}"
          bindtap="switchTimePeriod"
          data-period="1H"
        >1H</view>
        <view
          class="period-item {{timePeriod === '4H' ? 'active' : ''}}"
          bindtap="switchTimePeriod"
          data-period="4H"
        >4H</view>
        <view
          class="period-item {{timePeriod === '1D' ? 'active' : ''}}"
          bindtap="switchTimePeriod"
          data-period="1D"
        >1D</view>
      </view>

      <!-- æŒ‡æ ‡åˆ‡æ¢æŒ‰é’® -->
      <view class="indicator-toggles">
        <view
          class="indicator-btn {{enabledIndicators.boll ? 'active' : ''}}"
          bindtap="toggleIndicator"
          data-indicator="boll"
        >BOLL</view>
        <view
          class="indicator-btn {{enabledIndicators.ma ? 'active' : ''}}"
          bindtap="toggleIndicator"
          data-indicator="ma"
        >MA</view>
        <view
          class="indicator-btn {{enabledIndicators.ema ? 'active' : ''}}"
          bindtap="toggleIndicator"
          data-indicator="ema"
        >EMA</view>
        <view
          class="indicator-btn {{enabledIndicators.rsi ? 'active' : ''}}"
          bindtap="toggleIndicator"
          data-indicator="rsi"
        >RSI</view>
      </view>
    </view>

    <!-- Kçº¿å›¾ç»„ä»¶ -->
    <candlestick-chart
      id="candlestickChart"
      candles="{{candleData}}"
      sar-data="{{sarData}}"
      macd-data="{{macdData}}"
      rsi-data="{{rsiData}}"
      ma-data="{{maData}}"
      ema-data="{{emaData}}"
      boll-data="{{bollData}}"
      trade-signals="{{tradeSignals}}"
      current-price="{{currentPrice}}"
      height="580"
      enabled-indicators="{{enabledIndicators}}"
    />

    <!-- åŠ è½½æç¤º -->
    <view class="chart-loading" wx:if="{{loadingCandles}}">
      <view class="loading-spinner">
        <view class="spinner-dot"></view>
        <view class="spinner-dot"></view>
        <view class="spinner-dot"></view>
      </view>
      <text>åŠ è½½Kçº¿æ•°æ®ä¸­...</text>
    </view>
    <view class="chart-empty" wx:if="{{!loadingCandles && candleData.length === 0}}">
      <text>æš‚æ— Kçº¿æ•°æ®</text>
    </view>
  </view>

  <!-- çƒ­ç‚¹æ–°é—»åŒºåŸŸ -->
  <view class="news-section">
    <!-- æ–°é—»æ ‡é¢˜æ  -->
    <view class="news-header" bindtap="toggleNewsExpand">
      <view class="news-title-row">
        <view class="news-icon">
          <text class="news-icon-text">ğŸ“°</text>
        </view>
        <text class="news-title">åŠ å¯†è´§å¸å¿«è®¯</text>
        <view class="news-badge" wx:if="{{newsList.length > 0}}">
          <text>{{newsList.length}}</text>
        </view>
      </view>
      <view class="news-expand-icon {{newsExpanded ? 'expanded' : ''}}">
        <text>â–¼</text>
      </view>
    </view>

    <!-- æ–°é—»åˆ—è¡¨ -->
    <view class="news-list {{newsExpanded ? 'expanded' : ''}}">
      <!-- åŠ è½½ä¸­ -->
      <view class="news-loading" wx:if="{{newsLoading}}">
        <view class="loading-dots">
          <view class="dot"></view>
          <view class="dot"></view>
          <view class="dot"></view>
        </view>
        <text>åŠ è½½ä¸­...</text>
      </view>

      <!-- åŠ è½½å¤±è´¥ -->
      <view class="news-error" wx:elif="{{newsError}}">
        <text>åŠ è½½å¤±è´¥</text>
        <view class="retry-btn" bindtap="refreshNews">é‡è¯•</view>
      </view>

      <!-- æ–°é—»åˆ—è¡¨ -->
      <block wx:elif="{{newsList.length > 0}}">
        <view
          class="news-item"
          wx:for="{{newsList}}"
          wx:key="id"
          bindtap="onNewsTap"
          data-news="{{item}}"
        >
          <view class="news-item-left">
            <view class="news-type-tag {{item.isNew ? 'new' : ''}}">
              {{item.typeName || 'å…¬å‘Š'}}
            </view>
            <text class="news-item-title">{{item.title}}</text>
          </view>
          <view class="news-item-right">
            <text class="news-time">{{item.publishTimeFormatted}}</text>
            <text class="news-arrow">â€º</text>
          </view>
        </view>
      </block>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="news-empty" wx:else>
        <text>æš‚æ— æ–°é—»</text>
      </view>
    </view>
  </view>

  <!-- åŠ è½½ä¸­çŠ¶æ€ -->
  <view class="empty-state" wx:if="{{loading && filteredMarkets.length === 0}}">
    <view class="tech-loader">
      <view class="loader-ring"></view>
      <view class="loader-ring"></view>
      <view class="loader-ring"></view>
    </view>
    <text class="empty-text">åŠ è½½è¡Œæƒ…æ•°æ®ä¸­...</text>
  </view>
</view>
