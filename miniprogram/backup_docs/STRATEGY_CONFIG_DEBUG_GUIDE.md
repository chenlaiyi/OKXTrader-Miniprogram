# ç­–ç•¥é…ç½®ä¿å­˜é—®é¢˜è°ƒè¯•æŒ‡å—

## ğŸ› é—®é¢˜æè¿°
ç”¨æˆ·åé¦ˆï¼šæ¯æ¬¡ç‚¹è¿›å»ç­–ç•¥é…ç½®éƒ½æ˜¯ä¸€æ ·çš„æ•°æ®ï¼Œä¿®æ”¹åä¿å­˜ï¼Œä¸‹æ¬¡æ‰“å¼€è¿˜æ˜¯æ—§æ•°æ®ã€‚

## ğŸ” è°ƒè¯•æ­¥éª¤

### 1. æ£€æŸ¥å‰ç«¯ä¿å­˜æ—¥å¿—

#### æ­¥éª¤ï¼š
1. æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·
2. è¿›å…¥ **ç­–ç•¥ç¼–è¾‘** é¡µé¢
3. ä¿®æ”¹ **äº¤æ˜“æ¨¡å¼** ä¸º "çº¯ç­–ç•¥æ¨¡å¼"
4. ç‚¹å‡»å³ä¸Šè§’ **ä¿å­˜é…ç½®**
5. æŸ¥çœ‹ Console æ—¥å¿—

#### é¢„æœŸæ—¥å¿—ï¼š
```
ğŸ”˜ ä¿å­˜æŒ‰é’®è¢«ç‚¹å‡»ï¼
ğŸ“Š å½“å‰çŠ¶æ€: { isCreateMode: false, strategyId: null, saving: false }
ğŸ”˜ saveConfig è¢«è°ƒç”¨
ğŸ“ğŸ“ğŸ“ è¿›å…¥é»˜è®¤é…ç½®ä¿å­˜æ¨¡å¼åˆ†æ”¯ ğŸ“ğŸ“ğŸ“
ğŸ’¾ å‡†å¤‡ä¿å­˜ç­–ç•¥é…ç½®: {
  "basicConfig": {
    "tradingMode": "pure",  // âœ… åº”è¯¥æ˜¯ pure
    ...
  }
}
ğŸ“¡ å‡†å¤‡è°ƒç”¨ API.saveStrategyConfig...
âœ… API.saveStrategyConfig è°ƒç”¨å®Œæˆ
âœ… ä¿å­˜å“åº”: { success: true, data: { success: true } }
```

#### å¦‚æœçœ‹åˆ°é”™è¯¯ï¼š
- æ£€æŸ¥ç½‘ç»œè¯·æ±‚æ˜¯å¦æˆåŠŸï¼ˆNetwork æ ‡ç­¾ï¼‰
- æŸ¥çœ‹æ˜¯å¦æœ‰ "ä¿å­˜å¤±è´¥" çš„é”™è¯¯æç¤º

---

### 2. æ£€æŸ¥ç½‘ç»œè¯·æ±‚

#### æ­¥éª¤ï¼š
1. å¾®ä¿¡å¼€å‘è€…å·¥å…· â†’ **Network** æ ‡ç­¾
2. ä¿å­˜é…ç½®æ—¶ï¼ŒæŸ¥æ‰¾ `/api/strategy/config` è¯·æ±‚
3. æ£€æŸ¥ **Request Payload** å’Œ **Response**

#### é¢„æœŸ Request Payloadï¼š
```json
{
  "userId": "default",
  "config": {
    "basicConfig": {
      "symbol": "ETH-USDT-SWAP",
      "tradingMode": "pure",  // âœ… åº”è¯¥æ˜¯ pure
      ...
    },
    "buyConfig": { ... },
    "sellConfig": { ... },
    "fundConfig": { ... }
  }
}
```

#### é¢„æœŸ Responseï¼š
```json
{
  "success": true,
  "data": { "success": true }
}
```

#### å¦‚æœ Response æ˜¯ `{ success: false, error: "..." }`ï¼š
- è¯´æ˜åç«¯ä¿å­˜å¤±è´¥ï¼Œæ£€æŸ¥åç«¯æ—¥å¿—

---

### 3. æ£€æŸ¥åç«¯æ—¥å¿—

#### æ­¥éª¤ï¼š
```bash
ssh root@149.88.88.171 'pm2 logs okxtrader-api --lines 100'
```

#### æŸ¥æ‰¾å…³é”®æ—¥å¿—ï¼š
```
ğŸ“¥ æ”¶åˆ°ç­–ç•¥é…ç½®ä¿å­˜è¯·æ±‚: userId=default
ğŸ“Š config.sellConfig: { ... }
ğŸ” ç°æœ‰é…ç½®è®°å½•: æ˜¯
ğŸ”„ æ›´æ–°ç°æœ‰é…ç½®...
âœ… é…ç½®å·²æ›´æ–°
âœ… Strategy config saved for user default
```

#### å¦‚æœçœ‹åˆ°é”™è¯¯ï¼š
```
âŒ Save strategy config error: ...
```
- æ£€æŸ¥æ•°æ®åº“è¿æ¥
- æ£€æŸ¥ SQL è¯­å¥

---

### 4. æ£€æŸ¥æ•°æ®åº“æ•°æ®

#### æ–¹æ³•1: ç›´æ¥æŸ¥è¯¢æ•°æ®åº“ï¼ˆå¦‚æœå¯ä»¥è®¿é—®ï¼‰

```sql
-- æŸ¥çœ‹å®Œæ•´çš„ basic_config
SELECT user_id, basic_config FROM strategy_config WHERE user_id = 'default';

-- æŸ¥çœ‹ tradingMode å­—æ®µ
SELECT
  user_id,
  JSON_EXTRACT(basic_config, '$.tradingMode') as trading_mode,
  basic_config
FROM strategy_config
WHERE user_id = 'default';
```

#### é¢„æœŸç»“æœï¼š
```json
{
  "user_id": "default",
  "trading_mode": "pure",  // âœ… åº”è¯¥æ˜¯ pure
  "basic_config": {
    "tradingMode": "pure",
    ...
  }
}
```

#### æ–¹æ³•2: é€šè¿‡ API æŸ¥è¯¢

åœ¨å°ç¨‹åº Console ä¸­æ‰§è¡Œï¼š
```javascript
API.getStrategyConfig('default').then(res => {
  console.log('å®Œæ•´é…ç½®:', res);
  console.log('tradingMode:', res.data.basicConfig?.tradingMode);
});
```

---

### 5. æ£€æŸ¥å‰ç«¯åŠ è½½é€»è¾‘

#### é—®é¢˜å¯èƒ½åŸå› ï¼š
1. **ç¼“å­˜é—®é¢˜**ï¼šé¡µé¢ä½¿ç”¨äº†ç¼“å­˜çš„æ—§æ•°æ®
2. **åŠ è½½æ—¶æœºé—®é¢˜**ï¼šåœ¨ä¿å­˜å®Œæˆå‰å°±é‡æ–°åŠ è½½äº†
3. **æ•°æ®åˆå¹¶é—®é¢˜**ï¼šæ–°æ•°æ®è¢«æ—§æ•°æ®è¦†ç›–

#### æ£€æŸ¥åŠ è½½æ—¥å¿—ï¼š

è¿›å…¥ç­–ç•¥ç¼–è¾‘é¡µé¢æ—¶ï¼ŒConsole åº”è¯¥æ˜¾ç¤ºï¼š
```
ğŸ”„ é¡µé¢æ˜¾ç¤ºï¼Œé‡æ–°åŠ è½½é…ç½®...
âœ… ç­–ç•¥é…ç½®å·²åŠ è½½: {
  basicConfig: {
    tradingMode: "pure",  // âœ… åº”è¯¥æ˜¯ pure
    ...
  }
}
```

#### å¦‚æœæ˜¾ç¤º `tradingMode: "ai"`ï¼š
- è¯´æ˜æ•°æ®åº“ä¸­çš„æ•°æ®ç¡®å®æ˜¯ `ai`
- æˆ–è€…åŠ è½½é€»è¾‘æœ‰é—®é¢˜

---

### 6. æµ‹è¯•ä¿å­˜å’ŒåŠ è½½

#### åœ¨å°ç¨‹åº Console ä¸­æ‰§è¡Œï¼š
```javascript
// åŠ è½½æµ‹è¯•è„šæœ¬
require('../../test-strategy-config.js');

// è¿è¡Œå®Œæ•´æµ‹è¯•
wx.testStrategyConfig.testSaveAndLoad();
```

#### é¢„æœŸè¾“å‡ºï¼š
```
ğŸ§ª å¼€å§‹å®Œæ•´æµ‹è¯•ï¼šä¿å­˜ â†’ åŠ è½½ â†’ éªŒè¯
ğŸ§ª æµ‹è¯•ä¿å­˜ç­–ç•¥é…ç½®...
âœ… ä¿å­˜æˆåŠŸï¼
ğŸ§ª æµ‹è¯•åŠ è½½ç­–ç•¥é…ç½®...
âœ… åŠ è½½æˆåŠŸï¼
ğŸ“Š éªŒè¯ç»“æœ:
   tradingMode = "pure"
âœ…âœ…âœ… æµ‹è¯•é€šè¿‡ï¼tradingMode å·²æ­£ç¡®ä¿å­˜å’ŒåŠ è½½ âœ…âœ…âœ…
```

#### å¦‚æœæµ‹è¯•å¤±è´¥ï¼š
- è¯´æ˜åç«¯æˆ–æ•°æ®åº“æœ‰é—®é¢˜
- æ£€æŸ¥åç«¯æ—¥å¿—

---

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜1: ä¿å­˜æ—¶æ²¡æœ‰é”™è¯¯ï¼Œä½†æ•°æ®æ²¡æœ‰å˜åŒ–

**å¯èƒ½åŸå› **ï¼š
- ä¿å­˜çš„æ•°æ®å’Œæ•°æ®åº“ä¸­å·²æœ‰çš„æ•°æ®å®Œå…¨ç›¸åŒ
- å‰ç«¯å‘é€çš„è¯·æ±‚ä½“æœ‰è¯¯

**è§£å†³æ–¹æ³•**ï¼š
1. æ£€æŸ¥ Network æ ‡ç­¾ä¸­çš„ Request Payload
2. ç¡®è®¤ `tradingMode` å­—æ®µå­˜åœ¨ä¸”å€¼æ­£ç¡®

---

### é—®é¢˜2: ä¿å­˜æˆåŠŸï¼Œä½†åŠ è½½æ—¶è¿˜æ˜¯æ—§æ•°æ®

**å¯èƒ½åŸå› **ï¼š
- `onShow()` åœ¨ä¿å­˜å®Œæˆå‰å°±è¢«è§¦å‘äº†
- é¡µé¢æ•°æ®è¢«é‡ç½®

**è§£å†³æ–¹æ³•**ï¼š
1. æ£€æŸ¥ä¿å­˜å’ŒåŠ è½½çš„é¡ºåº
2. åœ¨ `onShow()` ä¸­æ·»åŠ å»¶è¿Ÿ

---

### é—®é¢˜3: æ•°æ®åº“ä¸­æœ‰æ•°æ®ï¼Œä½†å‰ç«¯åŠ è½½å¤±è´¥

**å¯èƒ½åŸå› **ï¼š
- API è¿”å›çš„æ•°æ®æ ¼å¼ä¸å¯¹
- å‰ç«¯è§£æé€»è¾‘æœ‰é—®é¢˜

**è§£å†³æ–¹æ³•**ï¼š
1. æ£€æŸ¥ API Response çš„æ ¼å¼
2. æ£€æŸ¥ `loadStrategyConfig()` ä¸­çš„æ•°æ®è§£æé€»è¾‘

---

## ğŸ”§ å¿«é€Ÿä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: å¼ºåˆ¶åˆ·æ–°é¡µé¢æ•°æ®

ä¿®æ”¹ `onShow()` æ–¹æ³•ï¼š
```javascript
onShow() {
  console.log('ğŸ”„ é¡µé¢æ˜¾ç¤ºï¼Œé‡æ–°åŠ è½½é…ç½®...');
  // å»¶è¿Ÿ 500msï¼Œç¡®ä¿ä¿å­˜å®Œæˆ
  setTimeout(() => {
    this.loadStrategyConfig();
  }, 500);
}
```

### æ–¹æ¡ˆ2: æ¸…é™¤ç¼“å­˜

åœ¨ä¿å­˜æˆåŠŸåï¼Œæ¸…é™¤é¡µé¢ç¼“å­˜ï¼š
```javascript
if (res.success) {
  wx.showToast({
    title: 'ç­–ç•¥å·²ä¿å­˜',
    icon: 'success'
  });

  // æ¸…é™¤ç¼“å­˜
  this.setData({
    basicConfig: { ...this.data.basicConfig }
  });

  setTimeout(() => {
    wx.navigateBack();
  }, 1500);
}
```

### æ–¹æ¡ˆ3: ä½¿ç”¨å…¨å±€å˜é‡

ä½¿ç”¨å…¨å±€å˜é‡å­˜å‚¨é…ç½®ï¼Œé¿å…æ¯æ¬¡éƒ½ä»æ•°æ®åº“åŠ è½½ï¼š
```javascript
const app = getApp();

// ä¿å­˜æ—¶
app.globalData.strategyConfig = config;

// åŠ è½½æ—¶
if (app.globalData.strategyConfig) {
  this.setData(app.globalData.strategyConfig);
} else {
  this.loadStrategyConfig();
}
```

---

## ğŸ“Š è°ƒè¯•æ£€æŸ¥æ¸…å•

- [ ] å‰ç«¯ä¿å­˜æ—¥å¿—æ­£å¸¸
- [ ] ç½‘ç»œè¯·æ±‚æˆåŠŸï¼ˆ200 OKï¼‰
- [ ] Request Payload åŒ…å«æ­£ç¡®çš„ `tradingMode`
- [ ] Response è¿”å› `{ success: true }`
- [ ] åç«¯æ—¥å¿—æ˜¾ç¤º "é…ç½®å·²æ›´æ–°"
- [ ] æ•°æ®åº“ä¸­ `tradingMode` å­—æ®µæ­£ç¡®
- [ ] å‰ç«¯åŠ è½½æ—¥å¿—æ˜¾ç¤ºæ­£ç¡®çš„ `tradingMode`
- [ ] æµ‹è¯•è„šæœ¬ `testSaveAndLoad()` é€šè¿‡

---

## ğŸ¯ ä¸‹ä¸€æ­¥

è¯·æŒ‰ç…§ä¸Šè¿°æ­¥éª¤é€ä¸€æ£€æŸ¥ï¼Œå¹¶å‘Šè¯‰æˆ‘ï¼š
1. å“ªä¸€æ­¥å‡ºç°äº†é—®é¢˜
2. å…·ä½“çš„é”™è¯¯æ—¥å¿—æˆ–æˆªå›¾

è¿™æ ·æˆ‘å¯ä»¥å¸®ä½ å®šä½å’Œä¿®å¤é—®é¢˜ã€‚
